<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Future Traffic Flow Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"
        integrity="sha512-z4OUqw38qNLpn1libAN9BsoDx6nbNFio5lA6CuTp9NlK83b89hgyCVq+N5FdBJptINztxn1Z3SaKSKUS5UP60Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="assets/js/matter.js"></script>
    <style>
        .float-right {
            float: right;
        }

        .float-end {
            clear: both;
        }

        #simulator-track {
            background-image: url('assets/img/track.png');
            height: 600px;
        }

        .grass {
            background-color: green;
            height: 20px
        }

        .square,
        .circle {
            pointer-events: none;
            position: relative;
            width: 28px;
            height: 28px;
            margin: 1px;
            background-color: purple;
            font-size: 14px;
        }

        .underline {
            text-decoration: underline;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-6">
                <h1>Future Traffic Flow Simulator</h1>
            </div>
            <div class="col-md-2"></div>
        </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
                    eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim
                    ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
                    aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit
                    in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui
                    officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="col-md-2"></div>
        </div>
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-4 text-center mb-2">
                <button type="button" id="add-regular-vehicle" class="btn btn-primary btn-lg">
                    <p>Add Regular Vehicle</p>
                    <p>
                        <u>Speed</u>:
                        <select class="speed">
                            <option>15 mph</option>
                            <option>30 mph</option>
                            <option>45 mph</option>
                            <option>60 mph</option>
                            <option>75 mph</option>
                            <option>90 mph</option>
                            <option>105 mph</option>
                        </select>
                    </p>
                </button>
            </div>
            <div class="col-md-4 text-center">
                <button type="button" id="add-autonomous-vehicle" class="btn btn-primary btn-lg">
                    <p>Add Autonomous Vehicle</p>
                    <p>
                        <u>Speed</u>:
                        <select class="speed">
                            <option>15 mph</option>
                            <option>30 mph</option>
                            <option>45 mph</option>
                            <option>60 mph</option>
                            <option>75 mph</option>
                            <option>90 mph</option>
                            <option>105 mph</option>
                        </select>
                    </p>
                </button>
            </div>
            <div class="col-md-2"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2 class="underline">Start</h2>
            </div>
        </div>
        <div class="row">
            <div id='simulator-track' class="col-md-12">
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2 class="float-right underline">Finish</h2>
            </div>
            <div class="float-end"></div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const templateVars = { regular_vehicles: [], autonomous_vehicles: [] };

            updateTemplate = () => {
                for (car in templateVars.regular_vehicles) {
                    console.log(templateVars.regular_vehicles[car]);
                    if (templateVars.regular_vehicles[car].active === 0) {
                        document.getElementById('first-lap').innerHTML += '<div class="square"></div>'
                        //anime({

                        //});
                        templateVars.regular_vehicles[car].active = 1;
                    }
                }
            };

            document.getElementById('add-regular-vehicle').addEventListener('click', (e) => {
                if (e.target.id === 'add-regular-vehicle') {
                    let HTMLquery = '#' + e.target.id + ' .speed option:checked';
                    templateVars.regular_vehicles.push({
                        speed: parseInt(document.querySelector(HTMLquery).value),
                        lane: Math.random() > 0.5 ? 'top' : 'bottom',
                        active: 0
                    });
                    //updateTemplate();
                }
            });

            document.getElementById('add-autonomous-vehicle').addEventListener('click', (e) => {
                let HTMLquery = '#' + e.target.id + ' .speed option:checked';
                templateVars.autonomous_vehicles.push({
                    speed: parseInt(document.querySelector(HTMLquery).value),
                    lane: Math.random() > 0.5 ? 'top' : 'bottom',
                    active: 0
                });
                //updateTemplate();
            });
          
            const engine = Matter.Engine.create();
            engine.gravity.y = 0; //top-down view
            const simulatorTrackSettings = { 
                height: 600, 
                width: 1320, 
                background: 'transparent', // Needed Needed to use background-image CSS rule
                wireframes: false // Needed Needed to use background-image CSS rule
            };

            // Create canvas for simulator track
            const render = Matter.Render.create({
                element: document.getElementById('simulator-track'),
                engine: engine,
                options: {
                    height: simulatorTrackSettings.height,
                    width: simulatorTrackSettings.width,
                    background: simulatorTrackSettings.background,
                    wireframes: simulatorTrackSettings.wireframes,
                }
            });


            // create two boxes and a ground
            //Bodies.recetangle() is for creating a shape object
            //let boxA = Matter.Bodies.rectangle(20, 50, 28, 28);
            //let boxB = Matter.Bodies.rectangle(20, 135, 28, 28);
            let boxC = Matter.Bodies.rectangle(20, 45, 28, 28);
            let boxD = Matter.Bodies.rectangle(20, 135, 28, 28);
            let boxE = Matter.Bodies.rectangle(20, 255, 28, 28);
            let boxF = Matter.Bodies.rectangle(20, 345, 28, 28);
            let boxG = Matter.Bodies.rectangle(20, 465, 28, 28);
            let boxH = Matter.Bodies.rectangle(20, 555, 28, 28);
            //let ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true });
            //boxA.setPosition(body, position)
            //Composite.create({gravity: 0})
            // add all of the bodies to the world
            Matter.Composite.add(engine.world, [boxC, boxD, boxE, boxF, boxG, boxH]);

            let lastTime = 0,
                scaleRate = 0.6;

            Matter.Events.on(engine, 'beforeUpdate', (event) => {
                let timeScale = (event.delta || (1000 / 60)) / 1000;

                // if (scaleRate > 0) {
                //     Bodies.scale(bodyF, 1 + (scaleRate * timeScale), 1 + (scaleRate * timeScale));

                //     // modify bodyE vertices
                //     bodyE.vertices[0].x -= 0.2 * timeScale;
                //     bodyE.vertices[0].y -= 0.2 * timeScale;
                //     bodyE.vertices[1].x += 0.2 * timeScale;
                //     bodyE.vertices[1].y -= 0.2 * timeScale;
                //     Bodies.setVertices(bodyE, bodyE.vertices);
                // }

                // make bodyA move up and down
                //var py = 300 + 100 * Math.sin(engine.timing.timestamp * 0.002);

                // manual update velocity required for older releases
                //if (Matter.version === '0.19.0') {
                    //Body.setSpeed(boxC, 3);
                    //Body.setVelocity(boxC, { x: 1 });
                    //Body.setPosition(boxC, {x: 500, y : boxC.position.y}, true);
                    //Body.setVelocity(boxA, { x: 2 });
                    //Body.setVelocity(boxB, { x: 3 });
                    //Body.setVelocity(compound, { x: 0, y: py - compound.position.y });
                    //Body.setAngularVelocity(compound, 1 * Math.PI * timeScale);
                //}

                // move body and update velocity
                //Bodies.setPosition(bodyA, { x: 100, y: py }, true);

                // move compound body move up and down and update velocity
                // Bodies.setPosition(compound, { x: 600, y: py }, true);

                // // rotate compound body and update angular velocity
                // Bodies.rotate(compound, 1 * Math.PI * timeScale, null, true);

                // // after first 0.8 sec (simulation time)
                // if (engine.timing.timestamp >= 800)
                //     Bodies.setStatic(bodyG, true);

                // every 1.5 sec (simulation time)
                if (engine.timing.timestamp - lastTime >= 1000) {
                    //15mph, 30mph, ..., 70mph is equal to the following `x` values
                    //  2, 2.5, ..., 5 
                    //Matter.Body.setVelocity(boxC, { x: 2, y: 0 })
                    //Matter.Body.setVelocity(boxD, { x: 5, y: 0 })
                    //Bodies.setVelocity(bodyB, { x: 0, y: -10 });
                    // Bodies.setAngle(bodyC, -Math.PI * 0.26);
                    // Bodies.setAngularVelocity(bodyD, 0.2);

                    // stop scaling
                    scaleRate = 0;

                    // update last time
                    lastTime = engine.timing.timestamp;
               }
            });

            // run the renderer
            Matter.Render.run(render);

            // create runner
            //let runner = Runner.create();

            // run the engine
            //Runner.run(runner, engine);

            //Matter.Render.run(render);
            Matter.Runner.run(Matter.Runner.create(), engine);
        });
    </script>
</body>

</html>